# 数据库配置说明

## Neon PostgreSQL 数据库集成

本项目已集成 Neon PostgreSQL 数据库，用于持久化存储任务数据。

### 环境变量配置

1. 在项目根目录创建 `.env.local` 文件
2. 添加以下环境变量：

```bash
DATABASE_URL=postgresql://neondb_owner:npg_bP4uCxh9izmG@ep-snowy-cake-a18k96av-pooler.ap-southeast-1.aws.neon.tech/neondb?sslmode=require&channel_binding=require
```

### 数据库表结构

数据库表结构定义在 `schema.sql` 文件中，需要手动执行该文件来创建表结构。

#### 手动创建表结构

1. 连接到您的 Neon PostgreSQL 数据库
2. 执行 `schema.sql` 文件中的 SQL 语句：

```bash
psql 'postgresql://neondb_owner:npg_bP4uCxh9izmG@ep-snowy-cake-a18k96av-pooler.ap-southeast-1.aws.neon.tech/neondb?sslmode=require&channel_binding=require' -f schema.sql
```

#### 主要表结构

- **tasks**: 存储数据抓取任务信息
  - `id`: 任务唯一标识符
  - `status`: 任务状态（pending/processing/completed/failed）
  - `urls`: 要抓取的URL列表
  - `created_at`: 任务创建时间
  - `completed_at`: 任务完成时间
  - `csv_url`: 生成的CSV文件URL
  - `error`: 任务错误信息

完整的表结构请参考 `schema.sql` 文件。

### 功能特性

- ✅ 任务数据持久化存储
- ✅ 手动数据库表初始化
- ✅ 任务状态实时更新
- ✅ 手动启动任务（用户控制）
- ✅ FastMoss数据抓取集成
- ✅ 抓取结果数据存储
- ✅ 自动登录和认证管理
- ✅ 错误处理和日志记录
- ✅ 数据格式转换和兼容性

### 启动项目

1. 安装依赖：`pnpm install`
2. 配置环境变量（创建 `.env.local` 文件）
3. **手动执行数据库表创建**（见上面的手动创建表结构步骤）
4. 启动开发服务器：`pnpm dev`

**注意**: 请确保在启动项目前先手动执行 `schema.sql` 文件创建数据库表。

### 技术特性

#### 任务ID生成
- 使用UUID v4生成唯一任务ID
- 格式：标准UUID格式，确保全局唯一性
- 避免时间戳可能产生的冲突

### FastMoss 数据抓取

系统集成了 FastMoss 数据抓取功能，支持以下特性：

#### 抓取流程
1. **自动登录**: 系统会自动登录 FastMoss 获取认证信息
2. **URL解析**: 从输入URL中自动提取商品ID
3. **进度跟踪**: 实时记录每个URL的抓取进度和状态
4. **分页抓取**: 自动翻页获取所有商品作者数据（无页数限制）
5. **实时写入**: 每页数据抓取完成后立即写入数据库
6. **智能停止**: 当某页数据不足5条时自动停止翻页

#### 抓取数据字段
- 达人昵称
- 达人粉丝数
- 国家/地区
- FastMoss达人详情页链接
- 商品销量（空值或0时记录为0）
- 商品销售额（空值或0时记录为0）
- 发布达人ID

#### 认证管理
- **全局认证管理**: 使用单例模式管理认证信息，所有任务共享
- **自动处理登录认证**: 系统自动使用预设凭据登录FastMoss
- **智能缓存**: 认证信息在内存中缓存1小时，避免重复登录
- **用户登录验证**: 获取认证信息前调用用户信息API验证登录状态
- **自动重新登录机制**: 检测到用户未登录时自动重新登录
- **并发安全**: 多个任务同时启动时，只进行一次登录，其他任务等待
- **状态监控**: 提供API端点查看当前认证状态和剩余时间
- **手动清除**: 支持手动清除认证信息强制重新登录
- **强制刷新**: 支持强制刷新认证信息，重新验证登录状态

#### 翻页机制
- **自动翻页**: 系统会自动翻页获取所有数据
- **智能停止**: 当某页数据少于5条时自动停止
- **页数限制**: 默认最多抓取100万页，可配置
- **实时写入**: 每页数据抓取完成后立即写入数据库
- **错误容错**: 单页失败不影响其他页面抓取
- **连续失败保护**: 连续失败3次后停止，避免无限循环
- **请求限流**: 页面间添加1秒延迟，失败后2秒延迟
- **完成状态管理**: 任务完成时自动设置进度状态为完成，并记录最终页数
- **总页数更新**: 任务完成时将实际抓取的最大页数设置为总页数
- **动态总页数**: 根据实际抓取情况动态更新总页数，而非预设的最大值

#### 数据处理优化
- **空值处理**: 自动处理API返回的空值、null、undefined数据
- **数值字段标准化**: 销量和销售额字段确保为数字类型，空值时记录为0
- **字符串字段安全**: 所有字符串字段提供默认空字符串，避免null值
- **销售额转换**: 智能处理"RM12.01万"等格式，空值时返回0
- **数据完整性**: 确保所有字段都有合适的默认值，提高数据质量

#### 实时写入优势
- **数据安全**: 即使抓取过程中断，已抓取的数据也不会丢失
- **实时查看**: 可以实时查看已抓取的数据，无需等待全部完成
- **内存优化**: 避免大量数据在内存中累积
- **容错性强**: 单页数据库写入失败不影响整体抓取进程

#### 进度跟踪功能
- **实时进度**: 实时记录每个URL的抓取页数和状态
- **错误记录**: 详细记录错误发生时间和错误原因
- **状态管理**: 跟踪每个URL的处理状态（等待中、处理中、已完成、失败）
- **统计信息**: 提供总体进度统计和完成率
- **API接口**: 通过 `/api/tasks/{taskId}/progress` 获取进度信息

#### 进度跟踪表结构
- **task_id + url**: 唯一键，确保每个URL的进度独立跟踪
- **current_page**: 当前抓取到第几页
- **total_pages**: 预估总页数
- **status**: 进度状态（pending/processing/completed/failed）
- **时间记录**: 开始时间、完成时间、错误时间
- **错误信息**: 详细的错误原因记录

#### 抓取配置
- **默认最大页数**: 1,000,000页（100万页）
- **每页数据量**: 5条记录
- **请求延迟**: 正常请求间1秒延迟
- **失败延迟**: 失败后2秒延迟
- **最大连续失败**: 3次后停止

#### 任务进度详情页面
- **独立路由**: 通过 `/tasks/[taskId]` 路由访问任务详情页面
- **实时监控**: 点击任务列表中的任意位置或"查看详情"按钮进入进度详情页
- **总体统计**: 显示总URL数、已完成数、失败数、处理中数等统计信息
- **完成率**: 实时显示任务完成百分比
- **URL详情**: 每个URL的详细抓取进度，包括当前页数、总页数、状态等
- **时间记录**: 显示开始时间、完成时间、错误时间等详细信息
- **错误信息**: 如果抓取失败，显示详细的错误原因
- **自动刷新**: 每5秒自动刷新进度信息
- **外部链接**: 可以直接点击URL在新窗口中打开FastMoss页面
- **返回功能**: 支持返回任务列表页面

#### 数据下载功能
- **完成状态限制**: 只有已完成的任务才能下载数据
- **实时查询**: 点击"下载CSV"按钮实时查询数据库中的最新数据
- **CSV格式**: 生成标准CSV格式文件，包含完整的抓取结果
- **数据完整性**: 包含核心业务字段：任务ID、商品URL、达人昵称、达人粉丝数、国家/地区、FastMoss详情页链接、商品销量、商品销售额、达人ID、原始销售额显示
- **销售额转换**: 在数据存储时自动将"RM12.01万"格式转换为数字120100，支持万、千等单位转换，去除英文前缀
- **原始数据存储**: 保存完整的API返回数据，便于后续分析和调试
- **错误处理**: 自动处理CSV字段中的特殊字符（逗号、引号、换行符）
- **空数据处理**: 即使没有抓取到数据也会生成包含表头的CSV文件
- **任务列表下载**: 在任务列表中直接点击"下载CSV"按钮进行下载

#### 使用方式
1. 创建任务时输入 FastMoss 商品页面URL
2. 点击"启动"按钮开始抓取
3. 点击"查看详情"按钮监控实时进度
4. 等待任务完成后，在任务列表中点击"下载CSV"按钮下载数据
5. 系统自动处理认证和数据抓取
6. 只有已完成的任务才能下载数据

#### API 端点

##### 认证状态管理
- **GET** `/api/auth/status` - 查看当前认证状态
  - 返回认证状态、剩余时间、用户登录状态、部分认证信息
  - 自动调用用户信息API验证登录有效性
- **POST** `/api/auth/status` - 强制刷新认证信息
  - 重新获取认证信息，如果用户未登录则自动重新登录
- **DELETE** `/api/auth/status` - 清除认证信息
  - 强制清除当前认证，下次请求将重新登录
